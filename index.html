<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول - نظام إدارة المحلات التجارية</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }
        
        .login-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            width: 400px;
            max-width: 90%;
            padding: 30px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .btn-login {
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-login:hover {
            background-color: #2980b9;
        }
        
        .btn-login:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .login-footer a {
            color: #3498db;
            text-decoration: none;
        }
        
        .login-footer a:hover {
            text-decoration: underline;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        .alert-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 480px) {
            .login-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <h1>نظام إدارة المحلات التجارية</h1>
            <p>يرجى تسجيل الدخول للوصول إلى النظام</p>
        </div>
        
        <div id="alertBox" class="alert"></div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">اسم المستخدم</label>
                <input type="text" id="username" name="username" required autocomplete="username">
            </div>
            
            <div class="form-group">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>
            
            <button type="submit" id="loginBtn" class="btn-login">
                تسجيل الدخول
            </button>
        </form>
        
        <div class="login-footer">
            <p>ليس لديك حساب؟ <a href="#" id="setupDemo">إعداد بيانات تجريبية</a></p>
        </div>
    </div>

    <script>
        // استيراد قاعدة البيانات من الملف الأصلي
        // في بيئة حقيقية، سنقوم باستيراد storeDB من ملف db.js
        // لأغراض هذا المثال، سنعيد تعريف الفئة هنا لتعمل بشكل مستقل
        
        class StoreManagementDB {
            constructor() {
                this.dbName = 'StoreManagementDB';
                this.version = 1;
                this.db = null;
            }

            // فتح الاتصال بقاعدة البيانات
            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => {
                        console.error('فشل في فتح قاعدة البيانات');
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('تم فتح قاعدة البيانات بنجاح');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        this.createStores(db);
                        console.log('تم إنشاء/ترقية قاعدة البيانات');
                    };
                });
            }

            // إنشاء جميع الجداول (object stores)
            createStores(db) {
                // جدول المنتجات
                if (!db.objectStoreNames.contains('products')) {
                    const productsStore = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                    productsStore.createIndex('categoryId', 'categoryId', { unique: false });
                    productsStore.createIndex('supplierId', 'supplierId', { unique: false });
                    productsStore.createIndex('barcode', 'barcode', { unique: true });
                    productsStore.createIndex('name', 'name', { unique: false });
                }

                // جدول الفئات
                if (!db.objectStoreNames.contains('categories')) {
                    const categoriesStore = db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    categoriesStore.createIndex('name', 'name', { unique: true });
                }

                // جدول الموردين
                if (!db.objectStoreNames.contains('suppliers')) {
                    const suppliersStore = db.createObjectStore('suppliers', { keyPath: 'id', autoIncrement: true });
                    suppliersStore.createIndex('name', 'name', { unique: true });
                    suppliersStore.createIndex('phone', 'phone', { unique: true });
                }

                // جدول العملاء
                if (!db.objectStoreNames.contains('customers')) {
                    const customersStore = db.createObjectStore('customers', { keyPath: 'id', autoIncrement: true });
                    customersStore.createIndex('phone', 'phone', { unique: true });
                    customersStore.createIndex('name', 'name', { unique: false });
                }

                // جدول المبيعات
                if (!db.objectStoreNames.contains('sales')) {
                    const salesStore = db.createObjectStore('sales', { keyPath: 'id', autoIncrement: true });
                    salesStore.createIndex('customerId', 'customerId', { unique: false });
                    salesStore.createIndex('date', 'date', { unique: false });
                    salesStore.createIndex('invoiceNumber', 'invoiceNumber', { unique: true });
                }

                // جدول تفاصيل المبيعات
                if (!db.objectStoreNames.contains('saleDetails')) {
                    const saleDetailsStore = db.createObjectStore('saleDetails', { keyPath: 'id', autoIncrement: true });
                    saleDetailsStore.createIndex('saleId', 'saleId', { unique: false });
                    saleDetailsStore.createIndex('productId', 'productId', { unique: false });
                }

                // جدول المشتريات
                if (!db.objectStoreNames.contains('purchases')) {
                    const purchasesStore = db.createObjectStore('purchases', { keyPath: 'id', autoIncrement: true });
                    purchasesStore.createIndex('supplierId', 'supplierId', { unique: false });
                    purchasesStore.createIndex('date', 'date', { unique: false });
                    purchasesStore.createIndex('invoiceNumber', 'invoiceNumber', { unique: true });
                }

                // جدول تفاصيل المشتريات
                if (!db.objectStoreNames.contains('purchaseDetails')) {
                    const purchaseDetailsStore = db.createObjectStore('purchaseDetails', { keyPath: 'id', autoIncrement: true });
                    purchaseDetailsStore.createIndex('purchaseId', 'purchaseId', { unique: false });
                    purchaseDetailsStore.createIndex('productId', 'productId', { unique: false });
                }

                // جدول المستخدمين
                if (!db.objectStoreNames.contains('users')) {
                    const usersStore = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
                    usersStore.createIndex('username', 'username', { unique: true });
                    usersStore.createIndex('email', 'email', { unique: true });
                }

                // جدول المخازن
                if (!db.objectStoreNames.contains('inventory')) {
                    const inventoryStore = db.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                    inventoryStore.createIndex('productId', 'productId', { unique: true });
                }

                // جدول الإعدادات
                if (!db.objectStoreNames.contains('settings')) {
                    const settingsStore = db.createObjectStore('settings', { keyPath: 'id', autoIncrement: true });
                    settingsStore.createIndex('key', 'key', { unique: true });
                }

                // جدول المصروفات
                if (!db.objectStoreNames.contains('expenses')) {
                    const expensesStore = db.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                    expensesStore.createIndex('date', 'date', { unique: false });
                    expensesStore.createIndex('category', 'category', { unique: false });
                }
            }

            // إضافة سجل جديد
            async add(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // الحصول على سجل بواسطة المعرف
            async get(storeName, id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // الحصول على جميع السجلات
            async getAll(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // تحديث سجل
            async update(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // حذف سجل
            async delete(storeName, id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);

                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            // الحصول على سجلات باستخدام الفهرس
            async getByIndex(storeName, indexName, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const index = store.index(indexName);
                    const request = index.getAll(value);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // الحصول على سجل واحد باستخدام الفهرس
            async getOneByIndex(storeName, indexName, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const index = store.index(indexName);
                    const request = index.get(value);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // إضافة بيانات أولية للاختبار
            async seedInitialData() {
                // إضافة فئات
                const categories = [
                    { name: 'أجهزة إلكترونية', description: 'الأجهزة الإلكترونية والكهربائية' },
                    { name: 'ملابس', description: 'ملابس رجالية ونسائية وأطفال' },
                    { name: 'أغذية', description: 'منتجات غذائية ومعلبات' },
                    { name: 'أثاث', description: 'أثاث منزلي ومكتبي' }
                ];

                for (const category of categories) {
                    await this.add('categories', category);
                }

                // إضافة موردين
                const suppliers = [
                    { 
                        name: 'شركة التقنية للأجهزة', 
                        phone: '0123456789', 
                        email: 'tech@example.com', 
                        address: 'شارع التجارة، الرياض' 
                    },
                    { 
                        name: 'مصنع الأزياء', 
                        phone: '0987654321', 
                        email: 'fashion@example.com', 
                        address: 'حي الصناعة، جدة' 
                    }
                ];

                for (const supplier of suppliers) {
                    await this.add('suppliers', supplier);
                }

                // إضافة منتجات
                const products = [
                    {
                        name: 'هاتف ذكي',
                        barcode: '1234567890123',
                        price: 1500,
                        cost: 1200,
                        quantity: 50,
                        categoryId: 1,
                        supplierId: 1,
                        minStock: 5
                    },
                    {
                        name: 'قلم جاف',
                        barcode: '1234567890124',
                        price: 2,
                        cost: 1,
                        quantity: 200,
                        categoryId: 1,
                        supplierId: 1,
                        minStock: 20
                    },
                    {
                        name: 'قميص رجالي',
                        barcode: '1234567890125',
                        price: 80,
                        cost: 50,
                        quantity: 100,
                        categoryId: 2,
                        supplierId: 2,
                        minStock: 10
                    }
                ];

                for (const product of products) {
                    await this.add('products', product);
                }

                // إضافة مستخدم
                const user = {
                    username: 'admin',
                    password: 'admin123', // في التطبيق الحقيقي يجب تشفير كلمة المرور
                    email: 'admin@store.com',
                    fullName: 'مدير النظام',
                    role: 'admin',
                    isActive: true
                };

                await this.add('users', user);

                // إضافة إعدادات
                const settings = [
                    { key: 'storeName', value: 'متجري الإلكتروني' },
                    { key: 'currency', value: 'ريال سعودي' },
                    { key: 'taxRate', value: '15' },
                    { key: 'receiptHeader', value: 'مرحبا بكم في متجرنا' }
                ];

                for (const setting of settings) {
                    await this.add('settings', setting);
                }

                console.log('تم إضافة البيانات الأولية بنجاح');
                return true;
            }

            // إنشاء فاتورة بيع جديدة
            async createSale(saleData, saleItems) {
                const transaction = this.db.transaction(['sales', 'saleDetails', 'inventory', 'products'], 'readwrite');
                
                return new Promise((resolve, reject) => {
                    transaction.oncomplete = () => resolve(true);
                    transaction.onerror = () => reject(transaction.error);
                    
                    // إضافة الفاتورة
                    const salesStore = transaction.objectStore('sales');
                    const saleRequest = salesStore.add(saleData);
                    
                    saleRequest.onsuccess = (event) => {
                        const saleId = event.target.result;
                        
                        // إضافة عناصر الفاتورة وتحديث المخزون
                        const saleDetailsStore = transaction.objectStore('saleDetails');
                        const inventoryStore = transaction.objectStore('inventory');
                        const productsStore = transaction.objectStore('products');
                        
                        saleItems.forEach(async (item) => {
                            // إضافة عنصر الفاتورة
                            const saleDetail = { ...item, saleId };
                            saleDetailsStore.add(saleDetail);
                            
                            // تحديث كمية المنتج في المخزون
                            const productRequest = productsStore.get(item.productId);
                            productRequest.onsuccess = (e) => {
                                const product = e.target.result;
                                if (product) {
                                    product.quantity -= item.quantity;
                                    productsStore.put(product);
                                }
                            };
                        });
                    };
                });
            }

            // إنشاء فاتورة شراء جديدة
            async createPurchase(purchaseData, purchaseItems) {
                const transaction = this.db.transaction(['purchases', 'purchaseDetails', 'inventory', 'products'], 'readwrite');
                
                return new Promise((resolve, reject) => {
                    transaction.oncomplete = () => resolve(true);
                    transaction.onerror = () => reject(transaction.error);
                    
                    // إضافة الفاتورة
                    const purchasesStore = transaction.objectStore('purchases');
                    const purchaseRequest = purchasesStore.add(purchaseData);
                    
                    purchaseRequest.onsuccess = (event) => {
                        const purchaseId = event.target.result;
                        
                        // إضافة عناصر الفاتورة وتحديث المخزون
                        const purchaseDetailsStore = transaction.objectStore('purchaseDetails');
                        const inventoryStore = transaction.objectStore('inventory');
                        const productsStore = transaction.objectStore('products');
                        
                        purchaseItems.forEach(async (item) => {
                            // إضافة عنصر الفاتورة
                            const purchaseDetail = { ...item, purchaseId };
                            purchaseDetailsStore.add(purchaseDetail);
                            
                            // تحديث كمية المنتج في المخزون
                            const productRequest = productsStore.get(item.productId);
                            productRequest.onsuccess = (e) => {
                                const product = e.target.result;
                                if (product) {
                                    product.quantity += item.quantity;
                                    product.cost = item.cost; // تحديث سعر التكلفة
                                    productsStore.put(product);
                                }
                            };
                        });
                    };
                });
            }

            // الحصول على تقرير المبيعات لفترة محددة
            async getSalesReport(startDate, endDate) {
                const sales = await this.getAll('sales');
                const filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= startDate && saleDate <= endDate;
                });
                
                let totalSales = 0;
                let totalItems = 0;
                
                for (const sale of filteredSales) {
                    totalSales += sale.totalAmount;
                    
                    const saleDetails = await this.getByIndex('saleDetails', 'saleId', sale.id);
                    totalItems += saleDetails.reduce((sum, detail) => sum + detail.quantity, 0);
                }
                
                return {
                    totalSales,
                    totalItems,
                    numberOfInvoices: filteredSales.length,
                    sales: filteredSales
                };
            }

            // الحصول على تقرير المنتجات الأكثر مبيعاً
            async getTopSellingProducts(limit = 10) {
                const saleDetails = await this.getAll('saleDetails');
                const productSales = {};
                
                // تجميع كميات البيع لكل منتج
                for (const detail of saleDetails) {
                    if (!productSales[detail.productId]) {
                        productSales[detail.productId] = 0;
                    }
                    productSales[detail.productId] += detail.quantity;
                }
                
                // تحويل إلى مصفوفة وترتيب تنازلي
                const topProducts = [];
                for (const productId in productSales) {
                    const product = await this.get('products', parseInt(productId));
                    if (product) {
                        topProducts.push({
                            productId: parseInt(productId),
                            productName: product.name,
                            quantitySold: productSales[productId],
                            revenue: productSales[productId] * product.price
                        });
                    }
                }
                
                return topProducts
                    .sort((a, b) => b.quantitySold - a.quantitySold)
                    .slice(0, limit);
            }

            // التحقق من المنتجات التي تحت مستوى المخزون الأدنى
            async checkLowStock() {
                const products = await this.getAll('products');
                return products.filter(product => product.quantity <= product.minStock);
            }

            // إغلاق الاتصال بقاعدة البيانات
            close() {
                if (this.db) {
                    this.db.close();
                    console.log('تم إغلاق قاعدة البيانات');
                }
            }
        }

        // إنشاء instance من قاعدة البيانات
        const storeDB = new StoreManagementDB();

        // فتح الاتصال بقاعدة البيانات عند التحميل
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await storeDB.open();
                console.log('تم تهيئة قاعدة البيانات بنجاح');
            } catch (error) {
                console.error('فشل في تهيئة قاعدة البيانات:', error);
                showAlert('فشل في تهيئة قاعدة البيانات. يرجى تحديث الصفحة والمحاولة مرة أخرى.', 'error');
            }
        });

        // وظائف إدارة واجهة المستخدم
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            
            // إخفاء التنبيه بعد 5 ثواني
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function setLoading(button, isLoading) {
            const btn = button || document.getElementById('loginBtn');
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = 'جاري التحقق <span class="loading"></span>';
            } else {
                btn.disabled = false;
                btn.textContent = 'تسجيل الدخول';
            }
        }

        // معالجة تسجيل الدخول
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showAlert('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                return;
            }
            
            setLoading(document.getElementById('loginBtn'), true);
            
            try {
                // البحث عن المستخدم في قاعدة البيانات
                const user = await storeDB.getOneByIndex('users', 'username', username);
                
                if (!user) {
                    showAlert('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
                    setLoading(document.getElementById('loginBtn'), false);
                    return;
                }
                
                // في تطبيق حقيقي، يجب استخدام تشفير لكلمات المرور
                if (user.password !== password) {
                    showAlert('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
                    setLoading(document.getElementById('loginBtn'), false);
                    return;
                }
                
                if (!user.isActive) {
                    showAlert('حسابك معطل. يرجى التواصل مع المسؤول', 'error');
                    setLoading(document.getElementById('loginBtn'), false);
                    return;
                }
                
                // تخزين بيانات المستخدم في localStorage للجلسة
                localStorage.setItem('currentUser', JSON.stringify({
                    id: user.id,
                    username: user.username,
                    fullName: user.fullName,
                    role: user.role,
                    email: user.email
                }));
                
                showAlert(`مرحباً ${user.fullName}! تم تسجيل الدخول بنجاح`, 'success');
                
                // الانتقال إلى الصفحة الرئيسية بعد تسجيل الدخول
                setTimeout(() => {
                    window.location.href = 'dashboard.html'; // يجب إنشاء هذه الصفحة لاحقاً
                }, 1500);
                
            } catch (error) {
                console.error('خطأ في تسجيل الدخول:', error);
                showAlert('حدث خطأ أثناء تسجيل الدخول. يرجى المحاولة مرة أخرى', 'error');
                setLoading(document.getElementById('loginBtn'), false);
            }
        });

        // إعداد البيانات التجريبية
        document.getElementById('setupDemo').addEventListener('click', async (e) => {
            e.preventDefault();
            
            setLoading(document.getElementById('loginBtn'), true);
            
            try {
                const result = await storeDB.seedInitialData();
                if (result) {
                    showAlert('تم إعداد البيانات التجريبية بنجاح. يمكنك الآن تسجيل الدخول باستخدام اسم المستخدم "admin" وكلمة المرور "admin123"', 'success');
                    
                    // تعبئة الحقول تلقائياً
                    document.getElementById('username').value = 'admin';
                    document.getElementById('password').value = 'admin123';
                }
            } catch (error) {
                console.error('خطأ في إعداد البيانات التجريبية:', error);
                showAlert('حدث خطأ أثناء إعداد البيانات التجريبية', 'error');
            } finally {
                setLoading(document.getElementById('loginBtn'), false);
            }
        });
    </script>
</body>
</html>
